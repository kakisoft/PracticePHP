【Laravel】スケジューラを使用する場合、キャッシュドライバに Redis を使うのは正解なのだろうか。

____________________________________________________________

表題の通り。  

Laravel でスケジューラからコマンド実行する場合、内部的にはキャッシュドライバを使用しています。（開発者として意識しない方もいるかとは思いますが）  

詳しくは、以下をご参照ください。 

[【Laravel】Schedule の onOneServer って、どんな動きをしているの？ Laravel のソースコードを追ってみた。](https://kaki-note-02.netlify.app/2021/07/24/)  
[【Laravel】schedule の onOneServer メソッドを使うと、スケジューラが安定しない？ キャッシュドライバが原因かもしれません。](https://kaki-note-02.netlify.app/2021/08/08/)  

キャッシュドライバには Redis が使われる事が多いですが、スケジューラを回す場面においては、それがとんでもない辛みを生み出していたので、今回のプロジェクトではキャッシュドライバを RDB に変えました。  

ちなみに、私一人が辛みを抱えて独断で決行したという訳ではなく、同じように苦しめられているメンバーが居て、彼と相談しつつ設定を変え、安定稼働した後も「やっぱキャッシュドライバを RDB に変えて正解だったね。」と話をしました。  

## スケジューラの裏で何が起こっているか
スケジューラからコマンドを叩く時、こんな感じでメソッドを並べていくかと思います。
```php
    $schedule->command(Batch01Command::class)
        ->everyMinute()
        ->runInBackground()
        ->withoutOverlapping()
        ->onOneServer()
        ->onSuccess(function () {
            \Log::info('Batch01Command successful.');
        })
        ->onFailure(function () {
            \Log::info('Batch01Command failed.');
        });
```

果たして、これらのメソッドの細かい挙動を把握しておられますでしょうか。  

このブログでは、Laravel のスケジューラ周りについては結構書いてて、[エントリ数もそれなりの数になりました](https://kaki-note-02.netlify.app/tags/batch)。  

というか、**ここまで調べておかないと、挙動を把握して安定稼働させる事が出来なかった**のです。  
（スケジューラによるバッチ処理がメインのシステムで、それらが複雑に絡み合っている、という側面もありますが。）  

## 起こっていた問題
頻繁に起こっていたのが、「スケジューラは動いているのに、コマンド（ジョブ）が実行されない」という現象でした。  

ちなみに、ローカル環境ではそんな事は特に発生していません。  
なので、AWS環境のみで発生する事象でした。  

スケジューラが内部的にキャッシュドライバを使っている事は分っていたので、変なロックがかかって後続のタスクが実行されていないのでは？  
という推測をするも、Redis だとそれは大きな辛みを生む。  
（詳しい説明は省略するが、上記のメソッドの挙動を把握していないと、キャッシュドライバでロックがかかってしまう現象は頻発する。  
その場合、ロックデータを削除し、再びスケジューラが動く状態にする必要がある。）  

AWS で Redis を使う場合、プライベートネットワークに配置するので、ローカルからはアクセスできず、踏み台サーバのようなものが必要になり Redis クライアントソフトも必要なる。  
また、RDB で select 文を叩くのと同じようなお手軽さで必要な情報を抽出しづらいく、問題の原因特定に結構な辛みを生む。  
RDB と比較すると、「どれが悪さをしているデータなのか」という事が、非常に絞り込みにくい。  

「１秒でも早く解決させなければならない」という緊急事態の場合、Redis 丸ごとオールリセットを取る方法が考えられると思うが、そうすると他のユーザが保持していたキャッシュもクリアされるので、出来る限り取りたくない手段となる。  

## RDB にする事で解決できる問題
キャッシュドライバを RDB に変えると、スケジューラにて使用しているキャッシュを簡単に絞り込む事が出来ます。  

詳細はこちらを。  
[【Laravel】キャッシュドライバをdatabase にする場合、chache のテーブルは２つ必要](https://kaki-note-02.netlify.app/2021/09/11/)  
[【Laravel】schedule の onOneServer メソッドを使うと、スケジューラが安定しない？ キャッシュドライバが原因かもしれません。](https://kaki-note-02.netlify.app/2021/08/08/)  

何か怪しい所があれば、select 文を叩いて調べ、該当のデータを delete。  
RDS なので、トンネルを使えばローカルマシンからでも制御可。  
超お手軽。  

特に、「AWS環境でしか起こらない問題」については、トレースが非常に難しくなる事が多く、保守容易性の確保は非常に重要な問題となります。  

RDB にする事で、速度は Redis と比較すると落ちる事になるかもしれませんが、スケジューラで処理している内容に比べると微々たる量ですし、何より安定性を犠牲にしてまで速度を重視する場面でもなかったので、RDB に切り替えました。  

## おわりに
「キャッシュドライバといえば Redis 一択」という考え方もアリなのかもしれませんが、場合によっては非常に大きな辛みを生む事もあるのではないかと思います。  

今回は割と特殊なケースなのかもしれませんが、キャッシュドライバに RDB を選択する事は、十分検討の余地があると思います。  
というか、今回のプロジェクトでは、再び Redis に切り替えるつもりは無いです。  


________________________________________________________________________________________________________________________________________

キャッシュドライバを RDBに変更。
これにより、キャッシュの状態を可視化できるようになりました。


ただし、キャッシュがクリアされていなくとも、ジョブは動く模様。

キャッシュが溜まっていく問題を無視し続けるわけにはいかないが、ジョブが動かない直接的な原因ではない。
21:00
キャッシュドライバにゴミが残らないようにする最小構成は以下。
（ onOneServer を実行しない ）




onOneServer は、「他のサーバが実行中の場合、該当のジョブを実行しない」という内容。

コンテナが複数存在する場合、これを使う事が推奨されている。
21:02
このメソッドは、時：分：秒　で実行中のジョブを識別している模様。

スケジュールは１分刻みだが、何らかの要因で、0:59 で実行される（もしくはそのように Laravel が判断する）と、「既に他のサーバが実行中」と判断する模様。
21:03
Laravel のスケジューラ実行には、以下の２種類がある
・php artisan schedule:run
・php artisan schedule:work
21:04
今回のシステムでは、
「php artisan schedule:run」を１分おきに AWS から実行している。
21:04
「php artisan schedule:work」
を使うと、AWS 側で cron を回さずとも、Laravel の待ち受けが起動して、ジョブを捌いてくれる。
8で追加された比較的新しい構文。

onOneServer も 8 で追加された比較的新しい構文。

推測ですが、onOneServer で内部的に時間計測しながらの重複チェックをする場合、schedule:work でなければ正確に処理されないのでは？
という可能性が浮上。
（ローカルで開発する時、cron で run を巡回して回すのが面倒だったので、work でスケジューラを回していた）








＜解決策＞
１．AWS 側を php artisan schedule:work で実行
２．onOneServer メソッドを実行しない
21:07
１．でも行ける可能性はあるが、100%それで上手く行く自信がない。
21:08
２．の場合、「withoutOverlapping」で重複実行は防止できているので、「onOneServer 」が無くとも正常に実行されると思われる。
（正確性を上げるために入れていました。）
21:09
＜現在＞
本番環境のキャッシュドライバも RDS で稼働中です。
ジョブスケジューラが正常に動いている事を確認しています。

ただし、キャッシュはクリアされず、蓄積したままなので、スケジューラ実行の内容を高瀬さんとも認識を合わせた後、
レコードが蓄積されないように修正しようかと思います。
（RDBなので、よほど大量のレコードが蓄積されない限り、問題ないかと思われます）

高瀬さんは、runInBackground （非同期処理を解除）する事でジョブを実行できるようにする方向を考えていましたが、
それよりは、onOneServer  を外して、時間軌道による重複チェックを外した方が良いのでは？という内容で、認識合わせをしようかと思います。



