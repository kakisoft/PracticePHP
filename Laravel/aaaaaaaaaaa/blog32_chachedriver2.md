【Laravel】スケジューラを使用する場合、キャッシュドライバに Redis を使うのは正解なのだろうか。


____________________________________________________________

表題の通り。



別にこれから






キャッシュドライバを RDBに変更。
これにより、キャッシュの状態を可視化できるようになりました。


ただし、キャッシュがクリアされていなくとも、ジョブは動く模様。

キャッシュが溜まっていく問題を無視し続けるわけにはいかないが、ジョブが動かない直接的な原因ではない。
21:00
キャッシュドライバにゴミが残らないようにする最小構成は以下。
（ onOneServer を実行しない ）




onOneServer は、「他のサーバが実行中の場合、該当のジョブを実行しない」という内容。

コンテナが複数存在する場合、これを使う事が推奨されている。
21:02
このメソッドは、時：分：秒　で実行中のジョブを識別している模様。

スケジュールは１分刻みだが、何らかの要因で、0:59 で実行される（もしくはそのように Laravel が判断する）と、「既に他のサーバが実行中」と判断する模様。
21:03
Laravel のスケジューラ実行には、以下の２種類がある
・php artisan schedule:run
・php artisan schedule:work
21:04
今回のシステムでは、
「php artisan schedule:run」を１分おきに AWS から実行している。
21:04
「php artisan schedule:work」
を使うと、AWS 側で cron を回さずとも、Laravel の待ち受けが起動して、ジョブを捌いてくれる。
8で追加された比較的新しい構文。

onOneServer も 8 で追加された比較的新しい構文。

推測ですが、onOneServer で内部的に時間計測しながらの重複チェックをする場合、schedule:work でなければ正確に処理されないのでは？
という可能性が浮上。
（ローカルで開発する時、cron で run を巡回して回すのが面倒だったので、work でスケジューラを回していた）








＜解決策＞
１．AWS 側を php artisan schedule:work で実行
２．onOneServer メソッドを実行しない
21:07
１．でも行ける可能性はあるが、100%それで上手く行く自信がない。
21:08
２．の場合、「withoutOverlapping」で重複実行は防止できているので、「onOneServer 」が無くとも正常に実行されると思われる。
（正確性を上げるために入れていました。）
21:09
＜現在＞
本番環境のキャッシュドライバも RDS で稼働中です。
ジョブスケジューラが正常に動いている事を確認しています。

ただし、キャッシュはクリアされず、蓄積したままなので、スケジューラ実行の内容を高瀬さんとも認識を合わせた後、
レコードが蓄積されないように修正しようかと思います。
（RDBなので、よほど大量のレコードが蓄積されない限り、問題ないかと思われます）

高瀬さんは、runInBackground （非同期処理を解除）する事でジョブを実行できるようにする方向を考えていましたが、
それよりは、onOneServer  を外して、時間軌道による重複チェックを外した方が良いのでは？という内容で、認識合わせをしようかと思います。



