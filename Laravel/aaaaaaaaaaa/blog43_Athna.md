【AWS】Athena でログを検索できるようにしてみたけど、全然幸せになれなかった話

________________________________________

AWS Athena というサービスをご存じでしょうか。  

簡単に言えば、S3 にアップロードした CSV ファイルに対し、SQL を叩くような感覚でデータ分析ができるという代物です。  
詳しくは適当にググってみてください。  

ログ解析を目的に使用されている方もいるようで、実際にその目的でプロジェクトに導入してみました。  
しかし、かなりしんどいうえ、全く幸せになれず、最終的には Athena を使用したログ解析をしない方向に決めました。  

アクセスログの解析のように、単純に集計したい場合には有効かもしれませんが、**時系列が重要なログファイル解析には向きません。**  

## 辛い点１：設定



## 辛い点２：データ抽出




## 辛い点３：使い勝手
基本、AWS のコンソールを使ってクエリを叩く事になるのですが、結構使いづらい。  
世には無数の SQL クライアントソフトがあり、お好みのツールを使われているかと思いますが、


## 辛い点４：出力制御



## 結論
時系列が重要なログファイルの解析に、Athena は不向き。  

使い方次第では出来るかもしれませんが、

________________________________________________________________________________________________

Athena 、先頭をユニークなシーケンスID にしておけば少しは使い勝手が変わったかもしれないが、
そもそも Athena を使って幸せになるまでの道のりが遠すぎて、最早、１つ１つ解決していく気力が無くなりかけている。。




＜補足＞
Athena でログを確認する作業は、かなりキツい。

日付時間の粒度が荒く、スキーマを修正する必要がある。（かなり大変そう）

ログの出力単位に「秒」単位で保持していない（date_hour カラム）。
日付順で並べ替えた時、元の順番を保証しないようで、かなりバラバラになる。

また、Athena の性質上、料金がかさむため LIMIT をかけて参照する事が多いが、
order by をかけたあと LIMIT 50 とした場合、最新の 50 件が取れているとは限らない。
複数のファイルをまたぐ場合、その現象は顕著に表れる。

かといって、日付で絞り込みをしない場合、ログのフォルダのファイル全てが対象になるため、
抽出力が膨大となる。Athena の UI の悪さも相まって、必要な情報を探し出すのは、かなりキツイ。

そのため、後半は Athena を使用せず、S3 に出力されたファイルを直接確認していました。
（時間単位での絞り込みができ、時系列順に並んでいる）



Athenaは同感
・時系列で並べられない
・絞り込み前提で前後時系列で見れない
この２点だけで辛さを超えてNGだと思う




Atehna によるログの確認、以下の用途ではそれなりに使えそう。
・特定のログをピンポイントで絞り込む
・「ORDER BY log」と、log に出力された内容そのもので並び替えても問題が無いもの

一応、ピンポイントで使ってはいるものの、デメリットは大きいので、特にこだわらなくてもいいのではないかという印象





エラーの内容を、Athena から検索する時の辛みポイントを記述しました。

■Athena ログ確認の課題
https://docs.google.com/spreadsheets/d/1kLRjudwKIQsjY897F8OXrq_wXwsjXJqoIOAxZxwortI/edit#gid=1586132966プレビュー

最大の課題は「コマンドのログが出力されない」という問題で、これをクリアしても若干の問題が残ります。
https://docs.google.com/spreadsheets/d/1kLRjudwKIQsjY897F8OXrq_wXwsjXJqoIOAxZxwortI/edit#gid=1586132966&range=A68プレビュー

[To 高瀬さん]
他にも何かあれば教えてください。

※重要事項※　Athena は、抽出したデータ量に応じて課金がされます。からなず where 句で条件を絞り込んでください。








[To : 開発メンバー]
DevOps の wiki に、AWS のナレッジを更新しました。

（ログの確認）
https://bwave.backlog.com/wiki/HAPILOGI_DEVOPS/TIPS%2FAWS%2F%E3%83%AD%E3%82%B0%E3%81%AE%E7%A2%BA%E8%AA%8D

AWS Athena にて、S3 に出力したログを SQL のような構文で抽出できます。
SQL のテンプレートを作成し、雛形を呼び出して参照できるようにしていました。

保存していたテンプレートに、以下の修正を加えました。
（全テンプレートが対象）

＜変更点＞
・表示の上限を設けました。（「LIMIT 50」を追加）　※取得したデータ量に応じて課金されるため、制限をかけました
・表示順序を、日付の降順にしました。（ORDER BY datehour DESC を追加）




