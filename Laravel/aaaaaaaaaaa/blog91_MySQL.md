【MySQL・Laravel】insert 文発行時にデッドロックが発生した時の回避策

________________________________________________________________
【 環境 】
Laravel のバージョン： 8.16.1
PHP のバージョン： 7.4.7

## MySQL：insert 文発行時に発生するデッドロック
MySQL にて、update 文を発行した時にデッドロックが発生する事があります。  
詳細は以下を。  

[【MySQL・Laravel】意図されないインデックスが使用され、update時にロックがかかってしまった時の対応](https://kaki-note-02.netlify.app/2021/12/19/)  

update 文のみならず、insert 文を発行する時もデッドロックが発生する事があります。  

原理としては、以下のような感じです。  



＜参考（MySQL公式サイト）＞  
[14.6.5.2 構成可能な InnoDB の自動インクリメントロック](https://dev.mysql.com/doc/refman/5.6/ja/innodb-auto-increment-configurable.html)  

> InnoDB では AUTO_INCREMENT カラムを含むテーブルへの挿入を行う際に、AUTO-INC ロックと呼ばれる特殊なテーブルレベルロックが使用されます。  
> このロックは通常、指定された一連の INSERT ステートメントに予測可能かつ繰り返し可能な順序で自動インクリメント番号が割り当てられるように、(トランザクションが終了するまでではなく) ステートメントが終了するまで保持されます。


## 回避策

__________________________________________________________________________________________
__________________________________________________________________________________________
__________________________________________________________________________________________
__________________________________________________________________________________________
__________________________________________________________________________________________


## 14.6.5.2 構成可能な InnoDB の自動インクリメントロック
https://dev.mysql.com/doc/refman/5.6/ja/innodb-auto-increment-configurable.html


> InnoDB では AUTO_INCREMENT カラムを含むテーブルへの挿入を行う際に、AUTO-INC ロックと呼ばれる特殊なテーブルレベルロックが使用されます。  
> このロックは通常、指定された一連の INSERT ステートメントに予測可能かつ繰り返し可能な順序で自動インクリメント番号が割り当てられるように、(トランザクションが終了するまでではなく) ステートメントが終了するまで保持されます。



並列でジョブが起こると、避けられない

インクリメントしている限り、不可避


ULID



https://github.com/rorecek/laravel-ulid/blob/master/src/HasUlid.php

https://github.com/rorecek/laravel-ulid


デフォルトで入れる事ができない。





